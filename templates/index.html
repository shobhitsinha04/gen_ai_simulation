<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Simulation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: "Roboto", Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            font-size: 16px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        h1 {
            font-size: 2em;
            text-align: center;
            margin-top: 1em;
        }

        .clock-container {
            text-align: center;
            font-size: 1.2em;
            margin: 1em;
            font-weight: bold;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1em auto;
            font-size: 1.2em;
        }

        .slider-container label {
            margin-bottom: 0.5em;
            font-weight: bold;
        }

        .slider-container input[type="range"] {
            width: 70%; /* Larger slider width */
            margin: 1em 0;
            cursor: pointer;
        }

        .slider-container span {
            font-size: 1.2em;
            margin-top: 0.5em;
            font-weight: bold;
        }

        #map {
            height: 500px;
            width: 90%;
            margin: 1em auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1.5em 0;
            gap: 1em;
        }

        .controls input {
            font-size: 1em;
            padding: 0.5em;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .controls button {
            font-size: 1em;
            padding: 0.5em 1em;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .controls button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .agent-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1em auto;
        }

        .agent-buttons button {
            font-size: 1em;
            padding: 0.5em 1em;
            margin: 0.3em;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .agent-buttons button:hover {
            background-color: #1e7e34;
            transform: translateY(-2px);
        }

        .activity-display {
            width: 90%;
            margin: 2em auto;
            padding: 1em;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .activity-display h2 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 1em;
            color: #333;
        }

        .agent-activity {
            font-size: 1em;
            padding: 1em;
            margin: 1em 0;
            background-color: #ffffff; 
            border-left: 5px solid #007bff; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }

        .agent-activity:nth-child(even) {
            background-color: #f4f4f9; 
        }
    </style>    
</head>
<body>
    <h1>Multi-Agent Simulation</h1>
    <div class="clock-container">
        <span><span id="clock">00:00</span></span>
    </div>

    <div class="slider-container">
        <label for="timeSlider">Simulation Time:</label>
        <input type="range" id="timeSlider" min="0" max="1440" step="15" value="0">
        <span id="sliderTime">00:00</span>
    </div>

    <div id="map"></div>

    <div class="controls">
        <label for="startTime">Start Time:</label>
        <input type="text" id="startTime" placeholder="00:00">

        <button onclick="startDay()">Start Day</button>
    </div>

    <div class="agent-buttons" id="agentButtons">
        <!-- Agent toggle buttons will be populated here -->
    </div>

    <div class="activity-display">
        <h2>Agent Activities</h2>
        <div id="agent-activities"></div>
    </div>

    <script>
        let map;
        let agents = {};
        let time = 0; // Time in minutes, starting at 0 (00:00) by default
        let interval;
        const updateInterval = 15; // 15 minutes per interval
        let isAutoRunning = true;
        const agentColors = ["#FF5733", "#33FF57", "#3357FF", "#FF33A8", "#FF8F33", "#33FFF8", "#FF3333", "#8B33FF", "#FF8E33", "#33FF83"];

        function initMap() {
            map = L.map('map').setView([35.6895, 139.6917], 11); // Centered on Tokyo
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
            }).addTo(map);

            fetchAgents(); // Fetch and display agents on map initialization
        }

        function fetchAgents() {
            fetch('/start_day', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    agents = data.agents;
                    initializeAgentPaths();
                    populateAgentButtons();
                });
        }

        function populateAgentButtons() {
            const buttonsContainer = document.getElementById("agentButtons");
            buttonsContainer.innerHTML = ''; // Clear any previous buttons

            Object.keys(agents).forEach((agentId, index) => {
                const button = document.createElement("button");
                button.textContent = `Agent ${agentId.split('_').pop()}`;
                button.onclick = () => toggleAgentVisibility(agentId);
                buttonsContainer.appendChild(button);
            });
        }

        function toggleAgentVisibility(agentId) {
            const polyline = agents[agentId]?.polyline;
            const marker = agents[agentId]?.marker;

            if (polyline && marker) {
                if (map.hasLayer(polyline)) {
                    map.removeLayer(polyline);
                    map.removeLayer(marker);
                } else {
                    map.addLayer(polyline);
                    map.addLayer(marker);
                }
            }
        }

        function initializeAgentPaths() {
            Object.keys(agents).forEach((agentId, index) => {
                const color = agentColors[index % agentColors.length];
                agents[agentId].polyline = L.polyline([], { color: color, weight: 3 }).addTo(map);

                // Initialize an empty array for storing polyline points with timestamps
                agents[agentId].polylinePoints = [];

                // Add initial markers for each agent
                const firstActivity = agents[agentId][0];
                if (firstActivity) {
                    const lat = firstActivity.lat;
                    const lng = firstActivity.lng;
                    agents[agentId].marker = L.marker([lat, lng]).addTo(map);
                    agents[agentId].marker.bindTooltip(agentId.split('_').pop(), { permanent: true, direction: "right" }).openTooltip();
                }
            });
        }


        function startDay() {
            const startTime = document.getElementById("startTime").value.trim();
            if (!/^([0-1]\d|2[0-3]):([0-5]\d)$/.test(startTime)) {
                alert("Please enter a valid time in 24-hour format (e.g., 08:00).");
                return;
            }
            time = timeToMinutes(startTime); // Convert start time to minutes
            clearInterval(interval);         // Stop any previous simulation
            isAutoRunning = true;            // Allow automatic progression
            startSimulation();
        }

        function startSimulation() {
            clearInterval(interval);
            interval = setInterval(updateClock, 1000); // Slower time progression
            isAutoRunning = true;
            document.getElementById("timeSlider").value = time;
            document.getElementById("clock").textContent = formatTime(time);
        }

        function updateClock() {
            if (!isAutoRunning) return; // Skip updates if auto-running is disabled

            time += updateInterval; // Increment the time by the defined interval (15 mins)
            if (time >= 1440) {
                clearInterval(interval); // Stop when 24 hours is reached
            }

            // Update clock display and slider position
            document.getElementById("clock").textContent = `Time: ${formatTime(time)}`;
            document.getElementById("timeSlider").value = time;
            document.getElementById("sliderTime").textContent = formatTime(time);

            updateAgents();
        }




        function formatTime(minutes) {
            const hours = String(Math.floor(minutes / 60)).padStart(2, '0');
            const mins = String(minutes % 60).padStart(2, '0');
            return `${hours}:${mins}`;
        }

        function updateAgents() {
            const activityContainer = document.getElementById("agent-activities");
            const scrollTop = activityContainer.scrollTop; // Save the current scroll position

            activityContainer.innerHTML = ""; // Clear the activity display

            Object.keys(agents).forEach(agentId => {
                const activities = agents[agentId];
                const currentActivity = activities.find(activity => {
                    const startMinutes = timeToMinutes(activity.startTime);
                    const endMinutes = timeToMinutes(activity.endTime);
                    return time >= startMinutes && time < endMinutes;
                });

                if (currentActivity) {
                    updateAgentMarker(agentId, currentActivity.lat, currentActivity.lng);
                    addToAgentPath(agentId, currentActivity.lat, currentActivity.lng, time);
                    displayAgentActivity(agentId, currentActivity);
                }
            });

            activityContainer.scrollTop = scrollTop; // Restore the scroll position
        }



        function sliderChange(event) {
            // Stop automatic progression
            clearInterval(interval);

            // Get the slider's current value and update the time
            time = parseInt(event.target.value, 10); // Convert slider value to minutes
            document.getElementById("clock").textContent = `Time: ${formatTime(time)}`;
            document.getElementById("sliderTime").textContent = formatTime(time);

            // Update agents and their polylines based on slider time
            updateAgents();

            // Resume automatic progression from the slider's position
            isAutoRunning = true;
            interval = setInterval(updateClock, 1000); // Restart auto progression
        }




        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(":").map(Number);
            return hours * 60 + minutes;
        }

        function updateAgentMarker(agentId, lat, lng) {
            if (!agents[agentId].marker) {
                agents[agentId].marker = L.marker([lat, lng]).addTo(map);
                agents[agentId].marker.bindTooltip(agentId.split('_').pop(), { permanent: true, direction: "right" }).openTooltip();
            } else {
                agents[agentId].marker.setLatLng([lat, lng]);
            }
        }

        function addToAgentPath(agentId, lat, lng, currentTime) {
            if (!agents[agentId].polylinePoints) {
                agents[agentId].polylinePoints = [];
            }

            // Add the current point with its associated timestamp
            agents[agentId].polylinePoints.push({ lat, lng, time: currentTime });

            // Filter points to show only up to the current time
            const validPoints = agents[agentId].polylinePoints.filter(point => point.time <= currentTime);

            // Update the polyline with the valid points
            const latLngs = validPoints.map(point => [point.lat, point.lng]);
            agents[agentId].polyline.setLatLngs(latLngs);
        }


        function displayAgentActivity(agentId, activity) {
            const activityContainer = document.getElementById("agent-activities");

            const activityIcons = {
                "education": "üìö",
                "leisure activities": "üéâ",
                "sleep": "üõèÔ∏è",
                "work": "üíº",
                "shopping": "üõí",
            };

            const activityInfo = document.createElement("div");
            activityInfo.className = "agent-activity";
            activityInfo.style.borderLeftColor = agentColors[agentId.split('_').pop() % agentColors.length];
            activityInfo.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px; color: ${agentColors[agentId.split('_').pop() % agentColors.length]};">
                    Agent ${agentId.split('_').pop()}
                </div>
                <div>Activity: <strong>${activityIcons[activity.activityType] || "üè∑Ô∏è"} ${activity.activityType}</strong></div>
                <div>Location: <strong>${activity.locationType}</strong></div>
                <div>Time: <strong>${activity.startTime} - ${activity.endTime}</strong></div>
            `;

            activityContainer.appendChild(activityInfo);
        }


        document.getElementById("timeSlider").addEventListener("input", sliderChange);
        window.onload = initMap;
    </script>
</body>
</html>